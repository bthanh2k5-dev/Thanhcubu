<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Game Nông Trại - Popup chỉnh tọa độ</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #cce7a1;
    display: flex;
    justify-content: center;
  }

  /* Vùng chứa map */
  .map-container {
    position: relative;
    width: 100%;
    max-width: 800px;
    margin: 20px auto;
    border: 2px solid #333;
    overflow: hidden;
  }

  /* Hình nền bản đồ */
  .map-container img.map {
    width: 100%;
    display: block;
  }

  /* Popup hiển thị thông tin */
  .popup {
    display: none;          /* Ẩn mặc định */
    position: fixed;        /* Cố định theo màn hình */
    z-index: 1100;          /* Luôn nằm trên map */
    background: transparent;
  }

  /* Ảnh bên trong popup */
  .popup img {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: contain;    /* Giữ tỷ lệ ảnh */
  }

  /* Nút đóng dạng ảnh */
  .close-btn {
    position: absolute;
    top: 10px;      
    right: 10px;    
    width: 40px;
    height: 800px;
    border: none;
    background: url('https://github.com/bthanh2k5-dev/Thanhcubu/blob/main/Close%20(2).png?raw=true')
                no-repeat center center;
    background-size: contain;
    cursor: pointer;
  }

  /* Overlay nền mờ khi bật popup */
  .overlay {
    display: none;              /* Ẩn mặc định */
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.2); /* Màu đen mờ */
    z-index: 1000;              /* Nằm dưới popup */
  }
</style>
</head>
<body>

  <!-- Map chính -->
  <div class="map-container" id="mapContainer">
    <img id="map" class="map"
      src="https://raw.githubusercontent.com/bthanh2k5-dev/Thanhcubu/main/Map1.jpg"
      alt="map">
  </div>

  <!-- Overlay che mờ -->
  <div id="overlay" class="overlay"></div>

  <!-- Popup -->
  <div id="popup" class="popup">
    <button id="closePopup" class="close-btn"></button>
    <img id="popupImg" src="" alt="">
  </div>

<script>
/* Tham số gốc của map (dùng để scale) */
const ORIGINAL_MAP_W = 800;
const ORIGINAL_MAP_H = 600;

/* DOM phần tử */
const map = document.getElementById('map');
const mapContainer = document.getElementById('mapContainer');
const overlay = document.getElementById('overlay');
const popup = document.getElementById('popup');
const popupImg = document.getElementById('popupImg');
const closeBtn = document.getElementById('closePopup');

/* Danh sách vật thể (items) trên map */
const items = [
  {
    id: 'house',
    src: 'https://raw.githubusercontent.com/bthanh2k5-dev/Thanhcubu/main/main%20house.png',
    x: 200, y: 40, width: 300, height: 100, clickable: true,
    popupImg: 'https://github.com/bthanh2k5-dev/Thanhcubu/blob/main/warehouse%20tab.png?raw=true',
    popupX: 220, popupY: 20, popupWidth: 300, popupHeight: 400
  },
  {
    id: 'shop',
    src: 'https://raw.githubusercontent.com/bthanh2k5-dev/Thanhcubu/main/main%20house.png',
    x: 400, y: 150, width: 250, height: 120, clickable: true,
    popupImg: 'https://github.com/bthanh2k5-dev/Thanhcubu/blob/main/warehouse%20tab.png?raw=true',
    popupX: 420, popupY: 100, popupWidth: 300, popupHeight: 400
  }
];

  
  

/* Vẽ các item trên bản đồ */
function drawItems(){
  const scaleX = map.offsetWidth / ORIGINAL_MAP_W;
  const scaleY = map.offsetHeight / ORIGINAL_MAP_H;
  items.forEach(item=>{
    let el = document.getElementById(item.id);
    if(!el){
      // Nếu item chưa tồn tại -> tạo mới
      el = document.createElement('img');
      el.id = item.id;
      el.src = item.src;
      el.style.position = 'absolute';
      mapContainer.appendChild(el);
    }
    // Scale theo map
    el.style.width = (item.width * scaleX) + 'px';
    el.style.left  = (item.x * scaleX) + 'px';
    el.style.top   = (item.y * scaleY) + 'px';
    el.style.cursor = item.clickable ? 'pointer' : 'default';
  });
}

let currentPopupItem = null; // Lưu item đang mở popup

/* Lấy tỷ lệ zoom (nếu có) */
function getZoomScale() {
  const mapRect = map.getBoundingClientRect();
  const zoomScaleX = mapRect.width / map.offsetWidth;
  const zoomScaleY = mapRect.height / map.offsetHeight;
  return { x: zoomScaleX, y: zoomScaleY };
}

function showPopupFor(item){
  popupImg.src = item.popupImg || '';

  const w = 500;
  const h = 500;
  const margin = 700; // khoảng cách so với mép

  const left = window.innerWidth - w - margin;
  const top = margin;

  popup.style.left = left + 'px';
  popup.style.top = top + 'px';
  popup.style.width = w + 'px';
  popup.style.height = h + 'px';
  popup.style.display = 'block';
  overlay.style.display = 'block';

  currentPopupItem = item;
}


/* Ẩn popup */
function hidePopup(){
  popup.style.display = 'none';
  overlay.style.display = 'none';
  currentPopupItem = null;
}

/* Lắng nghe click trên map để mở popup */
mapContainer.addEventListener('click', (e)=>{
  const rect = mapContainer.getBoundingClientRect();
  const clickX = e.clientX - rect.left;
  const clickY = e.clientY - rect.top;
  const scaleX = map.offsetWidth / ORIGINAL_MAP_W;
  const scaleY = map.offsetHeight / ORIGINAL_MAP_H;

  // Kiểm tra click có nằm trong vùng item không
  for(const item of items){
    if(!item.clickable) continue;
    const itemX = item.x * scaleX;
    const itemY = item.y * scaleY;
    const itemW = item.width * scaleX;
    const itemH = item.height * scaleY;

    if(clickX >= itemX && clickX <= itemX + itemW &&
       clickY >= itemY && clickY <= itemY + itemH){
      e.preventDefault();
      showPopupFor(item);
      return;
    }
  }
});

/* Cập nhật lại vị trí popup khi thay đổi kích thước */
function repositionIfOpen(){
  if(!currentPopupItem) return;
  showPopupFor(currentPopupItem);
}

/* Đóng popup khi click overlay hoặc nút close */
closeBtn.addEventListener('click', hidePopup);
overlay.addEventListener('click', hidePopup);

/* Vẽ lại item khi load và resize */
window.addEventListener('load', ()=>{ drawItems(); });
window.addEventListener('resize', ()=>{ drawItems(); setTimeout(repositionIfOpen, 100); });

/* Khi scroll cũng reposition */
let scrollTimeout;
window.addEventListener('scroll', ()=>{ clearTimeout(scrollTimeout); scrollTimeout = setTimeout(repositionIfOpen, 16); });

/* Theo dõi resize bằng ResizeObserver */
const resizeObserver = new ResizeObserver(()=>{ setTimeout(repositionIfOpen, 50); });
resizeObserver.observe(map);

/* Nhấn ESC để đóng popup */
document.addEventListener('keydown', (e) => { if(e.key === 'Escape' && currentPopupItem) hidePopup(); });

</script>
</body>
</html>
