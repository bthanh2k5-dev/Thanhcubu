<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gh√©p tranh t√¨nh y√™u üíñ</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #fff0f5;
      text-align: center;
      margin: 0;
      padding: 20px;
      overflow-x: hidden;
    }
    h1 {
      color: #ff3366;
      font-size: 30px;
      margin-bottom: 20px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 150px);
      grid-gap: 5px;
      justify-content: center;
      margin-top: 20px;
      display: none; /* Hidden until game starts */
    }
    .piece {
      width: 150px;
      height: 150px;
      background: #ffc1d6;
      cursor: pointer;
      transition: all 0.3s ease;
      background-size: 450px 450px;
      background-repeat: no-repeat;
      filter: brightness(0) blur(6px);
    }
    .locked {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .revealed {
      filter: none;
      transform: scale(1.03);
    }
    #message {
      margin-top: 20px;
      font-size: 22px;
      color: #ff3366;
      font-weight: bold;
    }
    .question-box {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 2px solid #ff66aa;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 999;
      width: 80%;
      max-width: 320px;
    }
    .question-box button {
      display: block;
      width: 100%;
      margin-top: 10px;
      padding: 10px;
      font-size: 16px;
      background: #ffb6c1;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .question-box button:hover {
      background: #ff80aa;
    }
    /* Popup danh hi·ªáu */
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: #fff;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      z-index: 1000;
      text-align: center;
      transition: 0.4s;
    }
    .popup.active {
      transform: translate(-50%, -50%) scale(1);
    }
    .popup h2 {
      color: #ff3366;
      margin-bottom: 15px;
    }
    .popup button {
      background: #ff66aa;
      border: none;
      padding: 10px 20px;
      color: white;
      border-radius: 8px;
      cursor: pointer;
    }
    /* Hoa h∆∞·ªõng d∆∞∆°ng */
    .sunflower {
      position: fixed;
      bottom: 0;
      font-size: 20px;
      animation: float 4s linear forwards;
    }
    /* Emoji c∆∞·ªùi */
    .laugh {
      position: fixed;
      bottom: 0;
      font-size: 25px;
      animation: laughFloat 4s linear forwards;
    }
    @keyframes float {
      0% {transform: translateY(0); opacity: 1;}
      100% {transform: translateY(-100vh); opacity: 0;}
    }
    @keyframes laughFloat {
      0% {transform: translateY(0) rotate(0deg); opacity: 1;}
      100% {transform: translateY(-100vh) rotate(720deg); opacity: 0;}
    }
    /* N√∫t nh·∫•n ƒë·ªè 3D */
    #secretBtn {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: none;
      background: radial-gradient(circle at 30% 30%, #ff5c5c, #c70000 80%);
      box-shadow: 0 6px 0 #7a0000, 0 8px 15px rgba(0,0,0,0.4);
      cursor: pointer;
      transition: all 0.15s ease-in-out;
    }
    #secretBtn:active {
      transform: translateY(4px);
      box-shadow: 0 3px 0 #7a0000, 0 4px 8px rgba(0,0,0,0.3);
    }
    /* Status MQTT */
    #status {
      font-size: 22px;
      font-weight: bold;
      color: #444;
      padding: 15px 30px;
      border-radius: 12px;
      display: inline-block;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: 0.3s;
    }
    .connected {
      background-color: #d4edda;
      color: #155724;
    }
    .disconnected {
      background-color: #f8d7da;
      color: #721c24;
    }
    /* N√∫t b·∫Øt ƒë·∫ßu */
    #startBtn {
      margin-top: 40px;
      width: 90px;
      height: 90px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ff4d4d, #b30000);
      box-shadow: 0 5px 10px rgba(0,0,0,0.3);
      border: none;
      cursor: pointer;
      font-size: 18px;
      color: white;
      transition: 0.2s;
      display: none;
    }
    #startBtn:active {
      transform: scale(0.95);
      box-shadow: 0 2px 5px rgba(0,0,0,0.4);
    }
  </style>
</head>
<body>
  <h1>üíñ Tr√≤ ch∆°i gh√©p tranh t√¨nh y√™u üíñ</h1>
  <div id="status" class="disconnected">‚è≥ Vui l√≤ng ƒë·ª£i server k·∫øt n·ªëi...</div>
  <button id="startBtn" onclick="startGame()">B·∫Øt ƒë·∫ßu</button>
  <p id="hint" style="display: none;">B·∫•m v√†o n√∫t tr√≤n 10 l·∫ßn s·∫Ω c√≥ g·ª£i √Ω ƒë√°p √°n</p>
  <div class="grid" id="grid"></div>
  <div id="message"></div>
  <!-- Popup danh hi·ªáu -->
  <div id="popup" class="popup">
    <h2>üéâ Ch√∫c m·ª´ng! üéâ</h2>
    <p>B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c danh hi·ªáu<br><b style="color:#ff3366;">‚ÄúPhi·∫øu B√© Ngu‚Äù üê∑</b></p>
    <button onclick="closePopup()">T√¥i Ch·∫•p Nh·∫≠nüíï</button>
  </div>
  <!-- Popup troll -->
  <div id="trollPopup" class="popup">
    <h2>üòÜ Ahahah v·∫≠y c≈©ng tin :)))</h2>
    <p>B·∫•m 10 l·∫ßn thi·ªát h·∫£???</p>
    <button onclick="closeTroll()">Okok üòÇ</button>
  </div>
  <!-- N√∫t b√≠ ·∫©n -->
  <button id="secretBtn" style="display: none;"></button>
  <audio id="dingSound" src="https://www.soundjay.com/buttons/sounds/button-16.mp3" preload="auto"></audio>
  <audio id="laughSound" src="https://www.myinstants.com/media/sounds/trollolol.mp3" preload="auto"></audio>
  <script>
    let client;
    const grid = document.getElementById("grid");
    const message = document.getElementById("message");
    const popup = document.getElementById("popup");
    const trollPopup = document.getElementById("trollPopup");
    const secretBtn = document.getElementById("secretBtn");
    const dingSound = document.getElementById("dingSound");
    const laughSound = document.getElementById("laughSound");
    const hint = document.getElementById("hint");
    const image = "https://down-vn.img.susercontent.com/file/vn-11134207-7qukw-lfuw6kd4vhbe94@resize_w450_nl.webp";
    const questions = [
      { q: "H·∫πn h√≤ ng√†y n√†o", a: ["A. 5/9/2025", "B. 9/5/2024", "C. 9/5/2025"], correct: 2 },
      { q: "M√¨nh ch·ª•p m·∫•y t·∫•m photo book r·ªìi?", a: ["A. 5", "B. 4", "C. 3"], correct: 1 },
      { q: "Ai ƒë·∫πp trai nh·∫•t th·∫ø gi·ªõi?", a: ["A. Tr∆∞∆°ng b·∫£o Thanh", "B. Tr∆∞∆°ng B·∫£o Thanh", "C. Tr∆∞∆°ng B·∫£o thanh"], correct: 1 },
      { q: "Ai b·ªã kh·ªù?", a: ["A. Tr·∫ßn Th·ªã M·ªπ Trinh", "B. Tr·∫ßn Th·ªã M·ªπ Tr√¢n", "C. B·ªì th·∫±ng Thanh"], correct: 0 },
      { q: "20 nƒÉm tr∆∞·ªõc em bao nhi√™u tu·ªïi?", a: ["A. 20", "B. 91", "C. 97"], correct: 1 },
      { q: "T·∫°i sao 20 nƒÉm tr∆∞·ªõc em l·∫°i 91 tu·ªïi?", a: ["A. Kh√¥ng bi·∫øt", "B. Tao th√≠ch tao ghi v·∫≠y ƒë√≥ ƒëc hok?", "C. L√™u L√™u"], correct: 0 },
      { q: "Bu·ªïi s√°ng em th·ª©c d·∫≠y, ƒëi·ªÅu ƒë·∫ßu ti√™n n√™n l√†m l√† g√¨?", a: ["A. M·ªü m·∫Øt", "B. ƒê·ªãch banh ph√≤ng", "C. ƒêi ·ªâa"], correct: 0 },
      { q: "Bu·ªïi s√°ng em th·ª©c d·∫≠y, ƒëi·ªÅu th·ª© 2 em l√†m l√† g√¨?", a: ["A. ƒê√°nh rƒÉng (√Ω qu√™n em h√¥ng c√≥ ƒë√°nh rƒÉng)", "B. Nh·∫Øn cho anh", "C. ƒêi l√†m"], correct: 1 },
      { q: "N·∫øu anh b·ªã ∆∞·ªõt m∆∞a, em s·∫Ω...?", a: ["A. C·ªüi ƒë·ªì cho anh thay", "B. Nh·∫£y te te te", "C. Tr√∫ m∆∞a c√πng cho romance :33"], correct: 2 }
    ];
    let solved = 0;

    function connectMQTT() {
      const status = document.getElementById("status");
      const startBtn = document.getElementById("startBtn");

      client = mqtt.connect('wss://mqtt-dashboard.com:8884/mqtt');

      client.on('connect', () => {
        status.textContent = "üü¢ Server ƒë√£ k·∫øt n·ªëi! B·∫•m ƒë·ªÉ b·∫Øt ƒë·∫ßu ch∆°i üíï";
        status.classList.remove("disconnected");
        status.classList.add("connected");
        startBtn.style.display = "inline-block";
      });

      client.on('error', () => {
        status.textContent = "üî¥ L·ªói k·∫øt n·ªëi. ƒêang th·ª≠ l·∫°i...";
        status.classList.remove("connected");
        status.classList.add("disconnected");
        startBtn.style.display = "none";
      });

      client.on('close', () => {
        status.textContent = "‚ùå M·∫•t k·∫øt n·ªëi, vui l√≤ng ƒë·ª£i server...";
        status.classList.remove("connected");
        status.classList.add("disconnected");
        startBtn.style.display = "none";
      });
    }

    function startGame() {
      alert("üéÆ Tr√≤ ch∆°i b·∫Øt ƒë·∫ßu! Ch√∫c b·∫°n may m·∫Øn üíñ");
      document.getElementById("status").style.display = "none";
      document.getElementById("startBtn").style.display = "none";
      document.getElementById("grid").style.display = "grid";
      document.getElementById("hint").style.display = "block";
      secretBtn.style.display = "block";
      // Initialize puzzle pieces
      for (let i = 0; i < 9; i++) {
        const piece = document.createElement("div");
        piece.className = "piece" + (i > 0 ? " locked" : "");
        piece.style.backgroundImage = `url('${image}')`;
        const col = i % 3;
        const row = Math.floor(i / 3);
        piece.style.backgroundPosition = `-${col * 150}px -${row * 150}px`;
        piece.dataset.index = i;
        piece.addEventListener("click", showQuestion);
        grid.appendChild(piece);
      }
    }

    function showQuestion(e) {
      const i = Number(e.target.dataset.index);
      if (i > solved) {
        alert("üö´ B·∫°n ph·∫£i tr·∫£ l·ªùi ƒë√∫ng c√¢u tr∆∞·ªõc ƒë√£!");
        return;
      }
      const q = questions[i];
      const box = document.createElement("div");
      box.className = "question-box";
      box.innerHTML = `<h3>${q.q}</h3>`;
      q.a.forEach((ans, idx) => {
        const btn = document.createElement("button");
        btn.textContent = ans;
        btn.onclick = () => {
          if (idx === q.correct) {
            e.target.classList.add("revealed");
            e.target.classList.remove("locked");
            e.target.removeEventListener("click", showQuestion);
            box.remove();
            solved++;
            dingSound.play();
            if (solved < 9) grid.children[solved].classList.remove("locked");
            if (solved === 9) celebrate();
          } else {
            alert("Sai r·ªìi üòù Th·ª≠ l·∫°i nha!");
          }
        };
        box.appendChild(btn);
      });
      document.body.appendChild(box);
    }

    function celebrate() {
      message.innerHTML = "üåª Ch√∫c m·ª´ng b√© ƒë√£ ho√†n th√†nh gh√©p tranh üíï";
      popup.classList.add("active");
      // Send MQTT message to ESP32
      if (client && client.connected) {
        client.publish('esp32/text', 'ƒê√£ Ho√†n Th√†nh', { qos: 1 }, (err) => {
          if (err) {
            console.error('Failed to publish MQTT message:', err);
          } else {
            console.log('Published "ƒê√£ Ho√†n Th√†nh" to esp32/text');
          }
        });
      } else {
        console.error('MQTT client not connected');
      }
      for (let i = 0; i < 40; i++) {
        const flower = document.createElement("div");
        flower.className = "sunflower";
        flower.innerHTML = "üåª";
        flower.style.left = Math.random() * 100 + "vw";
        flower.style.fontSize = Math.random() * 25 + 15 + "px";
        flower.style.animationDuration = 3 + Math.random() * 2 + "s";
        document.body.appendChild(flower);
        setTimeout(() => flower.remove(), 4000);
      }
    }

    function closePopup() {
      popup.classList.remove("active");
    }

    let clickCount = 0;
    secretBtn.addEventListener("click", () => {
      clickCount++;
      secretBtn.style.transform = "scale(0.9)";
      setTimeout(() => secretBtn.style.transform = "scale(1)", 100);
      if (clickCount === 10) {
        trollPopup.classList.add("active");
        laughSound.play();
        spawnLaughs();
        clickCount = 0;
      }
    });

    function closeTroll() {
      trollPopup.classList.remove("active");
    }

    function spawnLaughs() {
      for (let i = 0; i < 30; i++) {
        const emoji = document.createElement("div");
        emoji.className = "laugh";
        emoji.innerHTML = ["ü§£","üòÇ","üòÜ","üòπ"][Math.floor(Math.random()*4)];
        emoji.style.left = Math.random() * 100 + "vw";
        emoji.style.animationDuration = 2 + Math.random() * 2 + "s";
        document.body.appendChild(emoji);
        setTimeout(() => emoji.remove(), 4000);
      }
    }

    window.onload = connectMQTT;
  </script>
</body>
</html>
